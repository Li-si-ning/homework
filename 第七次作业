#include <stdio.h>
#include <string.h>
#include <stdlib.h>

// 学生信息结构体
struct Student {
    char name[20];  // 姓名
    int id;         // 学号
    int score;      // 成绩
};

// 全局变量（动态管理学生）
struct Student *stu = NULL;  // 动态学生数组
int count = 0;               // 实际学生数量
int max = 0;                 // 数组最大容量

// 录入学生信息（动态扩容）
void add_stu() {
    // 容量不足时扩容（每次+5）
    if (count >= max) {
        max += 5;
        stu = (struct Student*)realloc(stu, max * sizeof(struct Student));
        if (stu == NULL) {
            printf("内存分配失败！\n");
            return;
        }
    }

    printf("-----录入第%d名学生-----\n", count + 1);
    printf("姓名：");
    scanf("%s", stu[count].name);

    printf("学号：");
    scanf("%d", &stu[count].id);

    // 成绩验证（0-100）
    do {
        printf("成绩(0-100)：");
        scanf("%d", &stu[count].score);
        if (stu[count].score < 0 || stu[count].score > 100) {
            printf("成绩无效！\n");
        }
    } while (stu[count].score < 0 || stu[count].score > 100);

    count++;
    printf("录入成功！共%d名学生。\n", count);
}

// 按学号查询
void search_id() {
    if (count == 0) {
        printf("无学生信息！\n");
        return;
    }

    int target;
    printf("输入学号：");
    scanf("%d", &target);

    int find = 0;
    for (int i = 0; i < count; i++) {
        if (stu[i].id == target) {
            printf("\n===找到学生===\n");
            printf("姓名：%s\n", stu[i].name);
            printf("学号：%d\n", stu[i].id);
            printf("成绩：%d\n", stu[i].score);
            find = 1;
            break;
        }
    }

    if (!find) {
        printf("未找到学号%d的学生！\n", target);
    }
}

// 按姓名模糊查询
void search_name() {
    if (count == 0) {
        printf("无学生信息！\n");
        return;
    }

    char target[20];
    printf("输入姓名关键词：");
    scanf("%s", target);

    int find = 0;
    for (int i = 0; i < count; i++) {
        if (strstr(stu[i].name, target) != NULL) {
            printf("\n===找到学生===\n");
            printf("姓名：%s\n", stu[i].name);
            printf("学号：%d\n", stu[i].id);
            printf("成绩：%d\n", stu[i].score);
            find = 1;
        }
    }

    if (!find) {
        printf("未找到包含「%s」的学生！\n", target);
    }
}

// 按学号升序排序
void sort_id() {
    for (int i = 0; i < count - 1; i++) {
        for (int j = 0; j < count - i - １; j++) {
            if (stu[j].id > stu[j+1].id) {
                struct Student temp = stu[j];
                stu[j] = stu[j+1];
                stu[j+1] = temp;
            }
        }
    }
    printf("按学号排序完成！\n");
}

// 按姓名升序排序
void sort_name() {
    for (int i = 0; i < count - 1; i++) {
        for (int j = 0; j < count - i - １; j++) {
            if (strcmp(stu[j].name, stu[j+1].name) > 0) {
                struct Student temp = stu[j];
                stu[j] = stu[j+1];
                stu[j+1] = temp;
            }
        }
    }
    printf("按姓名排序完成！\n");
}

// 按成绩降序排序
void sort_score() {
    for (int i = 0; i < count - 1; i++) {
        for (int j = 0; j < count - i - １; j++) {
            if (stu[j].score < stu[j+1].score) {
                struct Student temp = stu[j];
                stu[j] = stu[j+1];
                stu[j+1] = temp;
            }
        }
    }
    printf("按成绩排序完成！\n");
}

// 成绩统计
void calc_stats() {
    if (count == 0) {
        printf("无学生信息！\n");
        return;
    }

    float sum = 0;
    int maxs = stu[0].score;
    int mins = stu[0].score;
    for (int i = 0; i < count; i++) {
        sum += stu[i].score;
        if (stu[i].score > maxs) maxs = stu[i].score;
        if (stu[i].score < mins) mins = stu[i].score;
    }
    float avg = sum / count;

    int excellent = 0, good = 0, pass = 0, fail = 0;
    for (int i = 0; i < count; i++) {
        if (stu[i].score >= 90) excellent++;
        else if (stu[i].score >= 80) good++;
        else if (stu[i].score >= 60) pass++;
        else fail++;
    }

    printf("\n===成绩统计===\n");
    printf("1.平均分：%.2f\n", avg);
    printf("2.最高分：%d\n", maxs);
    printf("3.最低分：%d\n", mins);
    printf("4.分数段：\n");
    printf("   -优秀(90+)：%d人\n", excellent);
    printf("   -良好(80-89)：%d人\n", good);
    printf("   -及格(60-79)：%d人\n", pass);
    printf("   -不及格(<60)：%d人\n", fail);
}

// 主菜单
int main() {
    int choice;

    do {
        system("clear");
        printf("\n===学生信息管理系统===\n");
        printf("1.录入学生\n");
        printf("2.查询学生\n");
        printf("3.排序学生\n");
        printf("4.统计成绩\n");
        printf("0.退出系统\n");
        printf("选择功能(0-4)：");
        scanf("%d", &choice);

        switch (choice) {
            case 1:
                add_stu();
                break;
            case 2:
                printf("\n===查询方式===\n");
                printf("1.按学号\n");
                printf("2.按姓名\n");
                int qtype;
                scanf("%d", &qtype);
                if (qtype == 1) search_id();
                else if (qtype == 2) search_name();
                else printf("无效选择！\n");
                break;
            case 3:
                printf("\n===排序方式===\n");
                printf("1.按学号升序\n");
                printf("2.按姓名升序\n");
                printf("3.按成绩降序\n");
                int stype;
                scanf("%d", &stype);
                if (stype == 1) sort_id();
                else if (stype == 2) sort_name();
                else if (stype == 3) sort_score();
                else printf("无效选择！\n");

                printf("\n显示排序结果？(1.是/0.否)：");
                int show;
                scanf("%d", &show);
                if (show == 1) {
                    printf("\n===排序后列表===\n");
                    for (int i = 0; i < count; i++) {
                        printf("姓名：%s|学号：%d|成绩：%d\n", stu[i].name, stu[i].id, stu[i].score);
                    }
                }
                break;
            case 4:
                calc_stats();
                break;
            case 0:
                printf("退出系统！\n");
                break;
            default:
                printf("无效选择！\n");
        }

        if (choice != 0) {
            printf("\n按任意键返回菜单...");
            getchar();  // 吸收换行符
            getchar();  // 等待用户输入
        }

    } while (choice != 0);

    free(stu);
    return 0;
}
